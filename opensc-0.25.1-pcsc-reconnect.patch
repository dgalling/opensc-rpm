From cfe2445cb2331eb6e5bb80ccf3dd07da03cbf08b Mon Sep 17 00:00:00 2001
From: Frank Morgner <frankmorgner@gmail.com>
Date: Tue, 21 May 2024 10:25:54 +0200
Subject: [PATCH 1/2] pcsc: fixed unhandled error on reconnection

fixes https://github.com/OpenSC/OpenSC/issues/3139
---
 src/libopensc/reader-pcsc.c | 29 ++++++++++++-----------------
 1 file changed, 12 insertions(+), 17 deletions(-)

diff --git a/src/libopensc/reader-pcsc.c b/src/libopensc/reader-pcsc.c
index 723bcfd013..01eda86d99 100644
--- a/src/libopensc/reader-pcsc.c
+++ b/src/libopensc/reader-pcsc.c
@@ -276,11 +276,15 @@ static int pcsc_internal_transmit(sc_reader_t *reader,
 		case SCARD_E_INVALID_HANDLE:
 		case SCARD_E_INVALID_VALUE:
 		case SCARD_E_READER_UNAVAILABLE:
-			pcsc_connect(reader);
+			LOG_TEST_RET(reader->ctx,
+					pcsc_connect(reader),
+					"Could not connect to card after reattached reader.");
 			/* return failure so that upper layers will be notified */
 			return SC_ERROR_READER_REATTACHED;
 		case SCARD_W_RESET_CARD:
-			pcsc_reconnect(reader, SCARD_LEAVE_CARD);
+			LOG_TEST_RET(reader->ctx,
+					pcsc_reconnect(reader, SCARD_LEAVE_CARD),
+					"Could not reconnect to card after reattached reader.");
 			/* return failure so that upper layers will be notified */
 			return SC_ERROR_CARD_RESET;
 		default:
@@ -680,7 +684,6 @@ static int pcsc_disconnect(sc_reader_t * reader)
 static int pcsc_lock(sc_reader_t *reader)
 {
 	LONG rv;
-	int r;
 	struct pcsc_private_data *priv = reader->drv_data;
 
 	if (priv->gpriv->cardmod)
@@ -702,23 +705,15 @@ static int pcsc_lock(sc_reader_t *reader)
 			/* This is returned in case of the same reader was re-attached */
 		case SCARD_E_INVALID_HANDLE:
 		case SCARD_E_READER_UNAVAILABLE:
-			r = pcsc_connect(reader);
-			if (r != SC_SUCCESS) {
-				sc_log(reader->ctx, "pcsc_connect failed (%d)",
-						r);
-				return r;
-			}
+			LOG_TEST_RET(reader->ctx,
+					pcsc_connect(reader),
+					"Could not connect to card after reattached reader.");
 			/* return failure so that upper layers will be notified and try to lock again */
 			return SC_ERROR_READER_REATTACHED;
 		case SCARD_W_RESET_CARD:
-			/* try to reconnect if the card was reset by some other application */
-			PCSC_TRACE(reader, "SCardBeginTransaction calling pcsc_reconnect", rv);
-			r = pcsc_reconnect(reader, SCARD_LEAVE_CARD);
-			if (r != SC_SUCCESS) {
-				sc_log(reader->ctx,
-						"pcsc_reconnect failed (%d)", r);
-				return r;
-			}
+			LOG_TEST_RET(reader->ctx,
+					pcsc_reconnect(reader, SCARD_LEAVE_CARD),
+					"Could not reconnect to card after reattached reader.");
 			/* return failure so that upper layers will be notified and try to lock again */
 			return SC_ERROR_CARD_RESET;
 		case SCARD_S_SUCCESS:

From 6c8976fa7d0840aebe5e440495d33c6cc88aa9c0 Mon Sep 17 00:00:00 2001
From: Frank Morgner <frankmorgner@gmail.com>
Date: Tue, 21 May 2024 11:13:41 +0200
Subject: [PATCH 2/2] changed formatting

---
 src/libopensc/reader-pcsc.c | 22 ++++++++++------------
 1 file changed, 10 insertions(+), 12 deletions(-)

diff --git a/src/libopensc/reader-pcsc.c b/src/libopensc/reader-pcsc.c
index 01eda86d99..b7453dd68e 100644
--- a/src/libopensc/reader-pcsc.c
+++ b/src/libopensc/reader-pcsc.c
@@ -239,6 +239,7 @@ static int pcsc_internal_transmit(sc_reader_t *reader,
 	SCARD_IO_REQUEST sSendPci, sRecvPci;
 	DWORD dwSendLength, dwRecvLength;
 	LONG rv = SCARD_E_INVALID_VALUE;
+	int r;
 	SCARDHANDLE card;
 
 	LOG_FUNC_CALLED(reader->ctx);
@@ -276,15 +277,13 @@ static int pcsc_internal_transmit(sc_reader_t *reader,
 		case SCARD_E_INVALID_HANDLE:
 		case SCARD_E_INVALID_VALUE:
 		case SCARD_E_READER_UNAVAILABLE:
-			LOG_TEST_RET(reader->ctx,
-					pcsc_connect(reader),
-					"Could not connect to card after reattached reader.");
+			r = pcsc_connect(reader);
+			LOG_TEST_RET(reader->ctx, r, "Could not connect to card after reattached reader.");
 			/* return failure so that upper layers will be notified */
 			return SC_ERROR_READER_REATTACHED;
 		case SCARD_W_RESET_CARD:
-			LOG_TEST_RET(reader->ctx,
-					pcsc_reconnect(reader, SCARD_LEAVE_CARD),
-					"Could not reconnect to card after reattached reader.");
+			r = pcsc_reconnect(reader, SCARD_LEAVE_CARD);
+			LOG_TEST_RET(reader->ctx, r, "Could not reconnect to card after reattached reader.");
 			/* return failure so that upper layers will be notified */
 			return SC_ERROR_CARD_RESET;
 		default:
@@ -684,6 +683,7 @@ static int pcsc_disconnect(sc_reader_t * reader)
 static int pcsc_lock(sc_reader_t *reader)
 {
 	LONG rv;
+	int r;
 	struct pcsc_private_data *priv = reader->drv_data;
 
 	if (priv->gpriv->cardmod)
@@ -705,15 +705,13 @@ static int pcsc_lock(sc_reader_t *reader)
 			/* This is returned in case of the same reader was re-attached */
 		case SCARD_E_INVALID_HANDLE:
 		case SCARD_E_READER_UNAVAILABLE:
-			LOG_TEST_RET(reader->ctx,
-					pcsc_connect(reader),
-					"Could not connect to card after reattached reader.");
+			r = pcsc_connect(reader);
+			LOG_TEST_RET(reader->ctx, r, "Could not connect to card after reattached reader.");
 			/* return failure so that upper layers will be notified and try to lock again */
 			return SC_ERROR_READER_REATTACHED;
 		case SCARD_W_RESET_CARD:
-			LOG_TEST_RET(reader->ctx,
-					pcsc_reconnect(reader, SCARD_LEAVE_CARD),
-					"Could not reconnect to card after reattached reader.");
+			r = pcsc_reconnect(reader, SCARD_LEAVE_CARD);
+			LOG_TEST_RET(reader->ctx, r, "Could not reconnect to card after reattached reader.");
 			/* return failure so that upper layers will be notified and try to lock again */
 			return SC_ERROR_CARD_RESET;
 		case SCARD_S_SUCCESS:
